"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var patchedSym = Symbol('axiosBetterStacktrace.patched');
// toString used instead of instanceOf for detecting error type to prevent problem mentioned in issue #5
var isError = function (error) {
    return Object.prototype.toString.call(error) === '[object Error]';
};
var isAxiosError = function (error) {
    return isError(error) && error.isAxiosError;
};
var axiosMethods = [
    'request',
    'get',
    'delete',
    'head',
    'options',
    'post',
    'put',
    'patch',
];
var axiosBetterStacktrace = function (axiosInstance, opts) {
    if (opts === void 0) { opts = {}; }
    var _a = opts.errorMsg, errorMsg = _a === void 0 ? 'Axios Better Stacktrace' : _a;
    // do nothing if input does not look like an axios instance
    if (!axiosInstance || !axiosMethods.some(function (method) { return axiosInstance.hasOwnProperty(method); })) {
        return;
    }
    // avoid potential memory leaks if axios instance already patched
    if (axiosInstance[patchedSym]) {
        return;
    }
    var originalHandlers = {
        request: axiosInstance['request'],
        get: axiosInstance['get'],
        delete: axiosInstance['delete'],
        head: axiosInstance['head'],
        options: axiosInstance['options'],
        post: axiosInstance['post'],
        put: axiosInstance['put'],
        patch: axiosInstance['patch'],
    };
    // enhance original response error with a topmostError stack trace
    var responseErrorInterceptorId = axiosInstance.interceptors.response.use(function (response) {
        if (response.config && isError(response.config.topmostError)) {
            // remove topmostError to not clutter config and expose it to other interceptors down the chain
            delete response.config.topmostError;
        }
        return response;
    }, function (error) {
        if (isAxiosError(error) && error.config && isError(error.config.topmostError)) {
            error.originalStack = error.stack;
            error.stack = error.stack + "\n" + error.config.topmostError.stack;
            delete error.config.topmostError;
        }
        throw error;
    });
    axiosMethods.forEach(function (method) {
        if (method in axiosInstance) {
            switch (method) {
                case 'request': {
                    var originalHandler_1 = axiosInstance[method];
                    axiosInstance[method] = function axiosBetterStacktraceMethodProxy(config) {
                        return originalHandler_1(__assign(__assign({}, (config || {})), { topmostError: new Error(errorMsg) }));
                    };
                    break;
                }
                case 'get':
                case 'delete':
                case 'head':
                case 'options': {
                    var originalHandler_2 = axiosInstance[method];
                    axiosInstance[method] = function axiosBetterStacktraceMethodProxy(url, config) {
                        return originalHandler_2(url, __assign(__assign({}, (config || {})), { topmostError: new Error(errorMsg) }));
                    };
                    break;
                }
                case 'post':
                case 'put':
                case 'patch': {
                    var originalHandler_3 = axiosInstance[method];
                    axiosInstance[method] = function axiosBetterStacktraceMethodProxy(url, data, config) {
                        return originalHandler_3(url, data, __assign(__assign({}, (config || {})), { topmostError: new Error(errorMsg) }));
                    };
                    break;
                }
            }
            if (!axiosInstance[patchedSym]) {
                axiosInstance[patchedSym] = true;
            }
        }
    });
    // ensure consumer of the plugin can restore original handlers and remove custom interceptor
    return function () {
        axiosInstance.interceptors.response.eject(responseErrorInterceptorId);
        Object.assign(axiosInstance, originalHandlers);
    };
};
exports.default = axiosBetterStacktrace;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXhpb3NCZXR0ZXJTdGFja3RyYWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2F4aW9zQmV0dGVyU3RhY2t0cmFjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLCtCQUErQixDQUFDLENBQUM7QUFnQjNELHdHQUF3RztBQUN4RyxJQUFNLE9BQU8sR0FBRyxVQUFDLEtBQWM7SUFDN0IsT0FBQSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssZ0JBQWdCO0FBQTFELENBQTBELENBQUM7QUFFN0QsSUFBTSxZQUFZLEdBQUcsVUFBQyxLQUFjO0lBQ2xDLE9BQUEsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFLLEtBQW9CLENBQUMsWUFBWTtBQUFwRCxDQUFvRCxDQUFDO0FBRXZELElBQU0sWUFBWSxHQUFHO0lBQ25CLFNBQVM7SUFDVCxLQUFLO0lBQ0wsUUFBUTtJQUNSLE1BQU07SUFDTixTQUFTO0lBQ1QsTUFBTTtJQUNOLEtBQUs7SUFDTCxPQUFPO0NBQ0MsQ0FBQztBQUVYLElBQU0scUJBQXFCLEdBQUcsVUFBQyxhQUE2QixFQUFFLElBQWdDO0lBQWhDLHFCQUFBLEVBQUEsU0FBZ0M7SUFDcEYsSUFBQSxLQUF5QyxJQUFJLFNBQVQsRUFBcEMsUUFBUSxtQkFBRyx5QkFBeUIsS0FBQSxDQUFVO0lBRXRELDJEQUEyRDtJQUMzRCxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFDLE1BQU0sSUFBSyxPQUFBLGFBQWEsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEVBQXBDLENBQW9DLENBQUMsRUFBRTtRQUMxRixPQUFPO0tBQ1I7SUFFRCxpRUFBaUU7SUFDakUsSUFBSSxhQUFhLENBQUMsVUFBVSxDQUFDLEVBQUU7UUFDN0IsT0FBTztLQUNSO0lBRUQsSUFBTSxnQkFB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